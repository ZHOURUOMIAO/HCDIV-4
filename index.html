<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <style>
    #map {
      width: 100%;
      height: 600px;
    }
    h1 {
      text-align: center;
      font-family: Arial, sans-serif;
      font-size: 24px;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Population distribution map of Singapore (2023)</h1>
  <svg id="map"></svg>
  <div class="legend">
    <div>Population</div>
    <div id="color-bar" style="width: 200px; height: 20px;"></div>
  </div>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    let width = 1000, height = 600;

    let svg = d3.select("#map")
        .attr("viewBox", "0 0 " + width + " " + height);

    // 加载外部数据
    Promise.all([d3.json("sgmap.json"), d3.csv("population2023.csv")]).then(data => {
      let mapData = data[0].features;
      let popData = data[1];

      // 合并人口数据
      mapData.forEach(d => {
        let subzone = popData.find(e => e.Subzone.toUpperCase() == d.properties.Name);
        d.popdata = (subzone != undefined) ? parseInt(subzone.Population) : 0;
      });

      // 基于人口数据的颜色映射
      let colorScale = d3.scaleQuantize()
        .domain([0, d3.max(mapData, d => d.popdata)])
        .range(d3.schemeGreens[9]);

      // 地图投影
      let projection = d3.geoMercator()
          .center([103.851959, 1.290270])
          .fitExtent([[20, 20], [980, 580]], data[0]);

      let geopath = d3.geoPath().projection(projection);

      svg.append("g")
          .attr("id", "districts")
          .selectAll("path")
          .data(mapData)
          .enter()
          .append("path")
          .attr("d", geopath)
          .attr("stroke", "black")
          .attr("fill", d => colorScale(d.popdata))
          .on("mouseover", function(event, d) {
            let tooltip = d3.select("body").append("div")
              .style("position", "absolute")
              .style("background", "rgba(255, 255, 255, 0.8)")
              .style("padding", "5px")
              .style("border", "1px solid #ccc")
              .style("border-radius", "5px")
              .text(d.properties.Name + ": " + d.popdata + " people");
            tooltip.style("left", (event.pageX + 10) + "px")
              .style("top", (event.pageY + 10) + "px");
          })
          .on("mouseout", function() {
            d3.select("body").select("div").remove();
          });

      // 创建比例尺
      let scale = d3.scaleLinear()
          .domain([0, 1000000])
          .range([0, 150]);

      let scaleGroup = svg.append("g")
          .attr("transform", "translate(" + (width - 200) + ", " + (height - 40) + ")");

      scaleGroup.append("line")
          .attr("x1", 0)
          .attr("y1", 0)
          .attr("x2", scale(1000000))
          .attr("y2", 0)
          .attr("stroke", "black")
          .attr("stroke-width", 2);

      scaleGroup.append("text")
          .attr("x", scale(1000000) + 10)
          .attr("y", 5)
          .text("1 km")
          .style("font-size", "12px");

      // 添加颜色条
      let colorBar = d3.select("#color-bar");
      let legend = d3.legendColor()
          .scale(colorScale)
          .shapeWidth(30)
          .orient("horizontal")
          .labelFormat(d3.format(".0f"));
      
      colorBar.call(legend);
    });
  </script>
</body>
</html>

